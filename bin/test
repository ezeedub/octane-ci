#!/usr/bin/env bash
# Run tests for project.
# This is for functional/behavior tests that run after the site is installed.
# This is run within the Build/CLI container, so has all the tools.
#: exec_target = cli

set -e

# Allow for usage outside of containers for unit tests.
if [[ -z "$PROJECT_ROOT" ]]; then
  # Logic via https://stackoverflow.com/a/246128.
  PROJECT_ROOT="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )/.."
fi

# Define default test commands.
PHPUNIT_COMMAND="${PROJECT_ROOT}/vendor/bin/phpunit -c ${PROJECT_ROOT}/project/tests/phpunit.xml --printer \\Drupal\\Tests\\Listeners\\HtmlOutputPrinter"
BEHAT_COMMAND="${PROJECT_ROOT}/vendor/bin/behat -c ${PROJECT_ROOT}/project/tests/behat.yml -fprogress"

# Init the tools like npm within the cli container
if [ -e ~/.profile ]; then
  source ~/.profile
fi

# Set default testing URL for web host.
if [[ ! -z "$CI" && -z "$SIMPLETEST_BASE_URL" ]]; then
  export SIMPLETEST_BASE_URL=http://localhost
fi
# Set default ExistingSite test URL for web host.
if [[ -z "$DTT_BASE_URL" ]]; then
  export DTT_BASE_URL=${SIMPLETEST_BASE_URL}
fi

if [[ -z "$BEHAT_PARAMS" ]]; then
  export BEHAT_PARAMS='{"extensions" : {"Drupal\\MinkExtension" : {"base_url" : "'${DTT_BASE_URL}'"}, "Drupal\\DrupalExtension" : {"drupal" : {"drupal_root" : "'${PROJECT_ROOT}'/'${REL_DOCROOT}'"}}}}'
fi

if [[ ! -z "$1" && -z "$2" ]]; then
  # Single argument is testsuite.
  printf "$INFO_SLUG Running $1 tests...\n"
  if [[ "$1" == "behat" ]]; then
    # Run Behat.
    $BEHAT_COMMAND
  else
    $PHPUNIT_COMMAND --testsuite $1
  fi
elif [[ ! -z "$2" && "$1" == "behat" ]]; then
  # Multiple arguments for behat.
  printf "$INFO_SLUG Running Behat tests...\n"
  $BEHAT_COMMAND ${@:2}
elif [ ! -z "$2" ]; then
  # Multiple arguments, pass to phpunit.
  printf "$INFO_SLUG Running tests...\n"
  $PHPUNIT_COMMAND $@
else
  # Run all non-unit tests.
  printf "$INFO_SLUG Preparing to run all tests...\n\n"
  # Unit tests are run in a separate job before the build is deployed.
  printf "$INFO_SLUG Running Kernel tests...\n"
  $PHPUNIT_COMMAND --testsuite kernel
  printf "$INFO_SLUG Running Functional tests...\n"
  $PHPUNIT_COMMAND --testsuite functional
  printf "$INFO_SLUG Running Functional-Javascript tests...\n"
  $PHPUNIT_COMMAND --testsuite functional-javascript
  printf "$INFO_SLUG Running ExistingSite tests...\n"
  $PHPUNIT_COMMAND --testsuite existing-site

  if [[ -e ${PROJECT_ROOT}/project/tests/behat.yml ]]; then
    # Run all Behat tests
    printf "$INFO_SLUG Running Behat tests...\n"
    $BEHAT_COMMAND
  fi
fi
